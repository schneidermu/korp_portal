<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Росводресурсы - Профиль</title>
    <link rel="stylesheet" href="/front/styles/style_prof.css">
</head>
<body>
    <header>
        <div class="header-content">
            <img src="/front/src/rosvodres.png" alt="Росводресурсы Logo" class="logo">
            <img src="/front/src/search icon.png" alt="Search Icon" class="search-icon">
        </div>
    </header>
    <div class="nav-bar-container">
        <nav>
            <button onclick="location.href='/desktop'"> Рабочий стол </button>
            <button onclick="location.href='/profile'"> Мой профиль </button>
            <button onclick="location.href='/orgstruct'">Орг. структура</button>
        </nav>
    </div>
    <div class="search-bar-container">
        <div class="search-bar">
            <input type="text" placeholder="Поиск...">
        </div>
    </div>
    <main>
        <section class="profile-container">
            <div class="profile-panel">
                <form id="profileForm">
                    <div class="profile-header section">
                        <img src="/front/src/avatar.png" alt="Avatar">
                        <div class="profile-info">
                            <div>ФИО: <span id="fullName">Не указано</span></div>
                            <div>Статус: <span id="status">Не указано</span></div>
                            <div>Дата рождения: <span id="birthDate">Не указана</span></div>
                            <div>Телефон: <span id="telephone">Не указан</span></div>
                            <div>Почта: <span id="email">Не указана</span></div>
                            <div>Должность: <span id="jobTitle">Не указана</span></div>
                            <div>Классный чин: <span id="classRank">Не указан</span></div>
                            <div>Структурное подразделение: <span id="structuralDivision">Не указано</span></div>
                            <div>Тер. орган: <span id="organization">Не указано</span></div>
                        </div>
                    </div>
                    <hr class="divider">
                    <div class="edit-profile-section">
                        <button type="button" onclick="editProfile()">Редактировать профиль</button>
                    </div>
                </form>
            </div>
        </section>
    </main>
    <script>
        const token = localStorage.getItem('authToken');
        console.log("Token:", token);  // Output token to the console

        const headers = {
            'Authorization': `Token ${token}`,
            'Content-Type': 'application/json'
        };

        // Функция для загрузки данных пользователя и отображения в форме
        function loadUserProfile() {
            fetch('http://25.21.178.79:8000/api/colleagues/me', { headers })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Unauthorized');
                    }
                    return response.json();
                })
                .then(user => {
                    // Заполняем поля формы текущими данными пользователя
                    document.getElementById('fullName').textContent = user.fio || 'Не указано';
                    document.getElementById('status').textContent = user.status || 'Не указано';
                    document.getElementById('birthDate').textContent = user.birth_date ? new Date(user.birth_date).toLocaleDateString() : 'Не указана';
                    document.getElementById('telephone').textContent = user.telephone_number || 'Не указан';
                    document.getElementById('email').textContent = user.email || 'Не указана';
                    document.getElementById('jobTitle').textContent = user.job_title || 'Не указана';
                    document.getElementById('classRank').textContent = user.class_rank || 'Не указан';
                    document.getElementById('structuralDivision').textContent = user.structural_division || 'Не указано';
                    document.getElementById('organization').textContent = user.organization || 'Не указано';
                })
                .catch(error => {
                    console.error('Ошибка при загрузке профиля:', error);
                    if (error.message === 'Unauthorized') {
                        alert('Сеанс истек. Пожалуйста, выполните вход заново.');
                        window.location.href = '/login'; // Перенаправление на страницу входа
                    }
                });
        }

        // Функция для переключения в режим редактирования
	 function editProfile() {
            const profileInfo = document.querySelectorAll('.profile-info div span');
            profileInfo.forEach(span => {
                const input = document.createElement('input');
                input.type = span.id === 'birthDate' ? 'date' : 'text';
                input.value = span.textContent === 'Не указано' || span.textContent === 'Не указана' ? '' : span.textContent;
                input.id = span.id;

                // Обработка формата даты для поля birthDate
                if (input.id === 'birthDate' && input.value !== '') {
                    const parts = input.value.split('.');
                    if (parts.length === 3) {
                        input.value = `${parts[2]}-${parts[1]}-${parts[0]}`;
                    }
                }

                span.replaceWith(input);
            });

            const editButton = document.querySelector('.edit-profile-section button');
            editButton.textContent = 'Сохранить профиль';
            editButton.onclick = saveUserProfile;
        }	

        // Функция для отправки отредактированных данных
        function saveUserProfile() {
            const updatedUser = {
                fio: document.getElementById('fullName').value,
                status: document.getElementById('status').value,
                birth_date: document.getElementById('birthDate').value,
                telephone_number: document.getElementById('telephone').value,
                email: document.getElementById('email').value,
                job_title: document.getElementById('jobTitle').value,
                class_rank: document.getElementById('classRank').value,
                structural_division: document.getElementById('structuralDivision').value,
                organization: document.getElementById('organization').value
            };

            // Форматируем дату рождения в формат YYYY-MM-DD, если она не пустая
            if (updatedUser.birth_date) {
                const date = new Date(updatedUser.birth_date);
                updatedUser.birth_date = date.toISOString().split('T')[0];
            }

            fetch('http://25.21.178.79:8000/api/colleagues/me/', {
                method: 'PUT',
                headers,
                body: JSON.stringify(updatedUser)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update profile');
                }
                alert('Профиль успешно обновлен');
                location.reload(); // Перезагрузка страницы после успешного обновления
            })
            .catch(error => {
                console.error('Ошибка при обновлении профиля:', error);
            });
        }

        // Загружаем данные пользователя при загрузке страницы
        window.onload = loadUserProfile;
    </script>
</body>
</html>
